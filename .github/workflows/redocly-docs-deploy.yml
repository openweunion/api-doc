# Workflow for deploying Redocly docs to GitHub Pages
# Supports multiple branches deployed to different paths:
#   - main branch -> /
#   - develop branch -> /develop/
#   - feature/* branches -> /preview/<branch-name>/
name: Deploy Redocly Docs to Pages

on:
  push:
    branches:
      - main
      - develop
      - "feature/*"

  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref_name }}"
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    outputs:
      deploy-path: ${{ steps.set-path.outputs.path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Lint OpenAPI spec
        run: npx redocly lint openapi.yaml

      - name: Set deployment path
        id: set-path
        run: |
          BRANCH_NAME="${GITHUB_REF_NAME}"
          if [ "$BRANCH_NAME" == "main" ]; then
            echo "path=." >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "develop" ]; then
            echo "path=develop" >> $GITHUB_OUTPUT
          else
            # Replace / with - for feature branches
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
            echo "path=preview/${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Build Redocly HTML
        run: npx redocly build-docs openapi.yaml -o dist/index.html

      - name: Append Mermaid.js loader to HTML
        run: |
          cat >> dist/index.html << 'EOF'
          <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
          <script>
          (function() {
            mermaid.initialize({ startOnLoad: false });
            setTimeout(function() {
              document.querySelectorAll('code.language-mermaid').forEach(function(el) {
                var pre = el.parentElement;
                var div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = el.textContent;
                pre.parentElement.replaceChild(div, pre);
              });
              mermaid.init(undefined, '.mermaid');
            }, 1000);
          })();
          </script>
          EOF

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: redocly-docs-${{ github.ref_name }}
          path: "./dist"

  deploy:
    needs: build-docs
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: https://openweunion.github.io/api-doc/${{ needs.build-docs.outputs.deploy-path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: redocly-docs-${{ github.ref_name }}
          path: "./build"

      - name: Set deployment path
        id: set-path
        run: |
          BRANCH_NAME="${GITHUB_REF_NAME}"
          if [ "$BRANCH_NAME" == "main" ]; then
            echo "deploy_path=." >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "develop" ]; then
            echo "deploy_path=develop" >> $GITHUB_OUTPUT
          else
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
            echo "deploy_path=preview/${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to gh-pages branch
        run: |
          DEPLOY_PATH="${{ steps.set-path.outputs.deploy_path }}"

          # Save build files to temp location
          mkdir -p /tmp/build-output
          cp -r ./build/* /tmp/build-output/

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if gh-pages branch exists
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git fetch origin gh-pages
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
            touch .nojekyll
            git add .nojekyll
            git commit -m "Initialize gh-pages branch"
          fi

          # Copy files to deployment path
          if [ "$DEPLOY_PATH" == "." ]; then
            # For main branch, copy to root but preserve other directories (develop, preview)
            find . -maxdepth 1 -type f ! -name '.nojekyll' ! -name '.git' -delete 2>/dev/null || true
            cp -r /tmp/build-output/* .
          else
            rm -rf "${DEPLOY_PATH}" 2>/dev/null || true
            mkdir -p "${DEPLOY_PATH}"
            cp -r /tmp/build-output/* "${DEPLOY_PATH}/"
          fi

          # Add .nojekyll to disable Jekyll processing
          touch .nojekyll

          # Commit and push
          git add -A
          git diff --staged --quiet || git commit -m "Deploy ${GITHUB_REF_NAME} to ${DEPLOY_PATH}"
          git push origin gh-pages
